<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maldo-Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            overflow: auto;
        }
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            padding: 10px 0;
            margin: 0;
        }
        nav ul li {
            margin: 0 15px;
        }
        nav ul li a {
            text-decoration: none;
            color: #007bff;
            font-size: 24px;
        }
        nav ul li a:hover {
            color: #0056b3;
        }
        .dashboard {
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            margin-top: 60px; /* da se ne preklapa sa navigacijom */
            text-align: center;
        }
        .dashboard h2 {
            margin-bottom: 20px;
        }
        .dashboard p {
            margin: 10px 0;
            font-size: 18px;
        }
        .ocene {
    list-style-type: none;
    padding: 0;
    margin: 20px 0;
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    width: 100%; /* Povećava širinu da odgovara userInfo divu */
    max-width: 600px; /* Ograničava maksimalnu širinu */
}

.ocena-item {
    padding: 10px;
    border-bottom: 1px solid #ccc;
    margin-bottom: 10px;
}

.ocena-item:last-child {
    border-bottom: none;
}

.ocena-item p {
    margin: 0;
    font-size: 16px;
    color: #333;
}

.zahtevi {
            list-style-type: none;
            padding: 0;
            margin: 20px 0;
            width: 100%;
            max-width: 800px;
        }
        .zahtev-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .zahtev-item h4 {
            margin: 0;
            font-size: 18px;
        }
        .zahtev-item p {
            margin: 5px 0;
            color: #555;
        }
        .btn-accept {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-accept:hover {
            background-color: #0056b3;
        }
/* Stilovi za popup prozor */
.popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    max-width: 400px;
    background-color: #fff;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    z-index: 1000;
}

.popup h3 {
    margin-top: 0;
}

.popup p {
    margin: 10px 0;
}

.popup button.popup-close {
    background-color: #ff4d4d;
    border: none;
    color: #fff;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 4px;
    float: right;
}

.popup button.popup-close:hover {
    background-color: #ff1a1a;
}

.popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            z-index: 1000;
        }
        .popup h3 {
            margin-top: 0;
        }
        .popup p {
            margin: 10px 0;
            color: #555;
        }
        .popup button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            font-size: 18px;
        }
        .popup button:hover {
            background-color: #0056b3;
        }
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="profile.html"><i class="far fa-user"></i></a></li>
            <li><a href="dashboard.html"><i class="fas fa-house"></i></a></li>
            <li><a href="ponude.html"><i class="fas fa-truck-fast"></i></a></li>
        </ul>
    </nav>
    <section class="dashboard">
        <h2>Welcome to Your Dashboard</h2>
        <div id="userInfo">
            <!-- Podaci će biti popunjeni ovde -->
        </div>
        
    </section>
    <ul class="zahtevi">
        <!-- Zahtevi će biti popunjeni ovde -->
    </ul>

    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="popup" id="zahtevPopup">
        <button id="closePopup">Zatvori</button>
        <h3>Detalji Zahteva</h3>
        <div id="zahtevDetails">
            <!-- Detalji zahteva će biti prikazani ovde -->
        </div>
        <button id="acceptRequest">Prihvati</button>
    </div>
    <ul class="ocene"></ul>
    <div id="driverInfoPopup" class="popup">
        <button class="popup-close" onclick="hideDriverInfoPopup()">Zatvori</button>
        <div id="driverInfoContent">
            <!-- Ovde će biti popunjene informacije o vozaču -->
        </div>
    </div>
    <script>
        function getUserId() {
            return sessionStorage.getItem('userId');
        }

        document.addEventListener('DOMContentLoaded', async function() {
    const userId = getUserId();
    console.log('User ID:', userId);

    if (!userId) {
        alert('User ID not found, redirecting to login.');
        window.location.href = 'login.html';
        return;
    }

    const apiUrl = `https://kamioniapi20240730231858.azurewebsites.net/api/Poslodavac/${userId}`;
    console.log('API URL:', apiUrl);

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const userData = await response.json();
        console.log('Parsed JSON:', userData);

        // Proveravamo da li je userData objekat (nije niz)
        if (userData && typeof userData === 'object') {
            const userInfoDiv = document.getElementById('userInfo');
            userInfoDiv.innerHTML = `
                <p><strong>ID:</strong> ${userData.id}</p>
                <p><strong>Username:</strong> ${userData.username}</p>
                <p><strong>Email:</strong> ${userData.email}</p>
                <p><strong>Naziv:</strong> ${userData.naziv}</p>
                <p><strong>Telefon:</strong> ${userData.telefon}</p>
                <p><strong>Ocena:</strong> ${userData.ocena ?? 'N/A'}</p>
            `;
        } else {
            alert('Failed to fetch user data!');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});
        document.addEventListener('DOMContentLoaded', async function() {
    const userId = getUserId();
    if (!userId) {
        alert('User ID not found.');
        return;
    }
    
    const oceneUrl = `https://kamioniapi20240730231858.azurewebsites.net/api/OcenaPoslodavca/Poslodavac/${userId}`;

try {
    const response = await fetch(oceneUrl);

    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }

    const oceneData = await response.json();

    const oceneDiv = document.querySelector('.ocene');
    oceneDiv.innerHTML = ''; // Prazni element pre popunjavanja

    if (Array.isArray(oceneData) && oceneData.length > 0) {
        oceneData.forEach(ocena => {
            const ocenaElement = document.createElement('li');
            ocenaElement.className = 'ocena-item';
            ocenaElement.innerHTML = `
                <p>⭐ ${ocena.ocena}</p>
                <p>${ocena.komentar}</p>
            `;
            ocenaElement.addEventListener('click', () => {
                showDriverInfoPopup(ocena.vozac);
            });
            oceneDiv.appendChild(ocenaElement);
        });
    } else {
        console.warn('No ratings found for this employer.');
        oceneDiv.innerHTML = '<p>Trenutno nema ocena za ovog poslodavca.</p>';
    }
} catch (error) {
    console.error('Error fetching ratings:', error);
    alert('Došlo je do greške pri preuzimanju ocena: ' + error.message);
}
});

function showDriverInfoPopup(vozac) {
const popup = document.getElementById('driverInfoPopup');
const popupContent = document.getElementById('driverInfoContent');

popupContent.innerHTML = `
    <p><strong>Ime:</strong> ${vozac.ime}</p>
    <p><strong>Username:</strong> ${vozac.username}</p>
    <p><strong>Email:</strong> ${vozac.email}</p>
    <p><strong>Ocena:</strong> ${vozac.ocena}</p>
    <!-- Dodajte druge relevantne informacije o vozaču -->
`;

popup.style.display = 'block';
}

function hideDriverInfoPopup() {
const popup = document.getElementById('driverInfoPopup');
popup.style.display = 'none';
}

let zahteviData = [];

        document.addEventListener('DOMContentLoaded', async function() {
            const userId = sessionStorage.getItem('userId');
            const apiUrl = `https://kamioniapi20240730231858.azurewebsites.net/api/Zahtevi/Poslodavac/${userId}`;
            
            try {
                const response = await fetch(apiUrl);
                zahteviData = await response.json();

                if (response.ok && Array.isArray(zahteviData) && zahteviData.length > 0) {
                    const zahteviList = document.querySelector('.zahtevi');
                    zahteviList.innerHTML = ''; // Očistite listu pre popunjavanja

                    zahteviData.forEach(zahtev => {
                        const zahtevItem = document.createElement('li');
                        zahtevItem.className = 'zahtev-item';
                        zahtevItem.innerHTML = `
                            <div>
                                <h4>Ponuda: ${zahtev.NazivTereta}</h4>
                                <p>Vozač: ${zahtev.VozacIme} (${zahtev.VozacOcena}⭐)</p>
                            </div>
                            <button class="btn-accept" onclick="prikaziDetalje(${zahtev.ZahtevId})">Prihvati</button>
                        `;
                        zahteviList.appendChild(zahtevItem);
                    });
                } else {
                    document.querySelector('.zahtevi').innerHTML = '<p>Trenutno nema zahteva.</p>';
                }
            } catch (error) {
                console.error('Error fetching requests:', error);
                alert('Došlo je do greške pri preuzimanju zahteva: ' + error.message);
            }
        });

        function prikaziDetalje(zahtevId) {
            const zahtev = zahteviData.find(z => z.ZahtevId === zahtevId);

            const zahtevDetails = document.getElementById('zahtevDetails');
            zahtevDetails.innerHTML = `
                <p><strong>Ponuda:</strong> ${zahtev.NazivTereta}</p>
                <p><strong>Vrsta Tereta:</strong> ${zahtev.VrstaTereta}</p>
                <p><strong>Težina:</strong> ${zahtev.TezinaTereta} kg</p>
                <p><strong>Dimenzije:</strong> ${zahtev.DimenzijeTereta}</p>
                <p><strong>Mesto Polaska:</strong> ${zahtev.MestoPolaska}</p>
                <p><strong>Mesto Isporuke:</strong> ${zahtev.MestoIsporuke}</p>
                <p><strong>Datum Polaska:</strong> ${new Date(zahtev.DatumPolaska).toLocaleDateString()}</p>
                <p><strong>Datum Isporuke:</strong> ${new Date(zahtev.DatumIsporuke).toLocaleDateString()}</p>
                <p><strong>Dodatan Opis:</strong> ${zahtev.DodatanOpis}</p>
                <p><strong>Cena:</strong> ${zahtev.Cena} RSD</p>
                <hr>
                <p><strong>Vozač:</strong> ${zahtev.VozacIme}</p>
                <p><strong>Username:</strong> ${zahtev.VozacUsername}</p>
                <p><strong>Email:</strong> ${zahtev.VozacEmail}</p>
                <p><strong>Vozilo:</strong> ${zahtev.VozacVozilo}</p>
                <p><strong>Registracija:</strong> ${zahtev.VozacRegistracija}</p>
                <p><strong>Ocena:</strong> ${zahtev.VozacOcena}⭐</p>
            `;

            // Dodaj event listener za dugme "Prihvati"
            document.getElementById('acceptRequest').onclick = function() {
                prihvatiZahtev(zahtev.PonudaId, zahtev.VozacId);
            };

            // Prikaz popupa
            document.getElementById('popupOverlay').style.display = 'block';
            document.getElementById('zahtevPopup').style.display = 'block';
        }

        async function prihvatiZahtev(ponudaId, vozacId) {
            const acceptApiUrl = `https://kamioniapi20240730231858.azurewebsites.net/api/Ponuda/VozacId?ponudaId=${ponudaId}&vozacId=${vozacId}`;
            
            try {
                const response = await fetch(acceptApiUrl, {
                    method: 'PUT'
                });

                if (response.ok) {
                    alert('Vozač je uspešno ažuriran u ponudi.');
                    // Zatvori popup nakon uspešnog prihvatanja
                    document.getElementById('popupOverlay').style.display = 'none';
                    document.getElementById('zahtevPopup').style.display = 'none';
                    fetchOfferHistory(); // Osvežavanje istorije ponuda
                } else {
                    alert('Došlo je do greške pri prihvatanju zahteva.');
                }
            } catch (error) {
                console.error('Error accepting request:', error);
                alert('Došlo je do greške pri prihvatanju zahteva: ' + error.message);
            }
        }

        document.getElementById('closePopup').addEventListener('click', function() {
            document.getElementById('popupOverlay').style.display = 'none';
            document.getElementById('zahtevPopup').style.display = 'none';
        });
    </script>
</body>
</html>